#! /bin/bash

OUTPUT="$1"
OURSCP=$0
if echo "${OURSCP}" | grep '/' >/dev/null; then
	OURSCP="$(readlink -f "${OURSCP}")"
else
	OURSCP="$(which "${OURSCP}" 2>/dev/null)"
	if [ -z "${OURSCP}" ]; then
		echo 'Unable to find ourselves, aborting.' >&2
		exit 1
	fi
fi
OURDIR="$(dirname "${OURSCP}")"

TCLPACK="$(readlink -f "${OURDIR}/../../starkit2exe/tclkits/tclkit-8.4.18-linux-x86")"
SDXKIT="$(readlink -f "${OURDIR}/../../starkit2exe/support/sdx-1nrl.kit")"

if [ -z "${OUTPUT}" -o -z "$2" ]; then
	echo 'Usage: rivet2starkit <outputkit> <dirname:destdir> ...' >&2
	exit 1
fi

TMPRIVETDIR="${TMPDIR:-/tmp}/rivet2starkit-$$${RANDOM}${RANDOM}${RANDOM}"
mkdir "${TMPRIVETDIR}" || exit 1

TMPVFSDIR="${TMPRIVETDIR}/rivet.vfs"
rm -rf "${TMPVFSDIR}"

# Copy each source directory into the VFS area
shift
for srcdir in $*; do
	if echo "${srcdir}" | grep ':' >/dev/null; then
		dstdir=$(echo "${srcdir}" | cut -f 2 -d ':')
		srcdir=$(echo "${srcdir}" | cut -f 1 -d ':')
	else
		dstdir=""
	fi

	SRCDIR="$(readlink -f "${srcdir}")"
	if [ -z "${SRCDIR}" -o ! -e "${SRCDIR}" ]; then
		echo "File not found: ${SRCDIR}" >&2
		continue
	fi

	mkdir -p "${TMPVFSDIR}/$dstdir" >/dev/null 2>/dev/null
	cp -rp "${SRCDIR}"/* "${TMPVFSDIR}/$dstdir"
done

# Install main script
cp "${OURDIR}/../rivet-starkit/main.tcl" "${TMPVFSDIR}"

# Install requiste packages
mkdir "${TMPVFSDIR}/lib" >/dev/null 2>/dev/null
rm -rf "${TMPVFSDIR}/rivet-tcl"
cp -rp "${OURDIR}/../packages"/tclrivet "${TMPVFSDIR}/lib/"
cp -rp "${OURDIR}/../rivet-tcl" "${TMPVFSDIR}/"

# Add "Deny from all" .htaccess files where needed
echo "Deny from all" > "${TMPVFSDIR}/lib/.htaccess"
echo "Deny from all" > "${TMPVFSDIR}/rivet-tcl/.htaccess"

# Wrap VFS dir into kit
echo "${TCLPACK}" "${SDXKIT}" wrap "${TMPRIVETDIR}/rivet.kit"
(
	cd "${TMPRIVETDIR}"
	"${TCLPACK}" "${SDXKIT}" wrap rivet.kit
)

# Copy output kit to target
cp "${TMPRIVETDIR}/rivet.kit" "${OUTPUT}"

# Cleanup
rm -rf "${TMPRIVETDIR}"
